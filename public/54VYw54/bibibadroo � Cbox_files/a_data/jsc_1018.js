var cbx={ver:1018,lp:0};if(document.currentScript){var matches=document.currentScript.src.match(/_(.*)\.js/);matches&&1<matches.length&&(cbx.build=matches[1])}
var overlay=function(){var a,b,c,d,e,g=null,h=!1,k=null,l=function(m){a||(a=document.getElementById("overlay"),b=document.getElementById("overlayStage"),c=document.getElementById("barTitle"),d=document.getElementById("barDefault"),e=document.getElementById("barNotice"));k||(k=makeButton("ChevLeft","","",function(){l()},"btnTitle").enable());g&&(b.appendChild(g.body),g.isVisible=!1,g=null,document.body.onmousedown=n);a.innerHTML="";var n=document.body.onmousedown;m?(document.body.onmousedown=function(b){b=
b.target;do if(b===a)return;while(b=b.parentElement);l()},d.className="bar Hide",e.className="bar Hide",c.className="bar",k.text(m.title),a.appendChild(m.body),m.isVisible=!0,g=m,document.body.className="WithOverlay"+(h?" Full":"")):(document.body.className="",c.className="bar Hide",d.className="bar",e.className="bar Hide");cbx.autoScroll()};return{create:function(a,b){var c=document.createElement("div");c.className="ovr"+b;return{body:c,isVisible:!1,title:a?a:""}},switchTo:l,getCurrent:function(){return g},
setFull:function(a){g&&a!==h&&(h=a,document.body.className="WithOverlay"+(h?" Full":""))}}}(),windowIsFocused=!0,init=function(){cbx.debug.log("Starting");cbx.notifyParent("loading");var a=document.forms.cbox;window.f=cbx.$frm=a;s_no=8<window.name.length?window.name.substring(8):s_no;cbx.refreshBtn=makeButton("Circle","","",function(){return!1},"btnRefresh");s_on&&window.setTimeout(initOnliners,600);var b=overlay.create("Smilies","Smilies");makeButton("Smile","","Smilies",function(){overlay.switchTo(b.isVisible?
null:b);b.loaded||cbx.xhr("smilies",{xhr:1},null,function(c,e){b.body.innerHTML=c;b.loaded=!0;for(var d=document.getElementsByClassName("emoteBtn"),h=0;h<d.length;h++)(function(b){d[b].onclick=function(){insertAtCaret(d[b].getAttribute("data-code"));a.pst.focus()}})(h)})},"btnSmilies").enable();parent!==window?makeButton("Pop","","Pop out",function(a){var b=pop("",480,600,1);a.onclick(function(){b&&!b.closed?b.focus():b=pop("",480,600,1)})},"btnPop").enable():a.pst.focus();var c=makeButton("Go","",
"Post",function(){a.onsubmit()},"btnSubmit").disable();a.onsubmit=function(){return do_post()};if("TEXTAREA"==a.pst.tagName.toUpperCase()){var d=function(){a.pst.scrollHeight>a.pst.clientHeight&&(a.pst.style.height=a.pst.scrollHeight+"px",cbx.autoScroll());""==a.pst.value?(a.pst.style.height="auto",c.disable()):c.enable()};a.pst.onkeypress=function(b){d();if(13!=(window.event&&window.event.keyCode||b.keyCode||b.which))return!0;do_post()&&a.submit();return!1};a.pst.onfocus=function(a){document.getElementById("caret")&&
(document.getElementById("caret").className="Hide");d()};a.pst.onchange=d;a.pst.onkeyup=a.pst.oninput=function(a){this.value.length>s_ml&&(this.value=this.value.substring(0,s_ml));d()}}cbx.gsUser=cbx.getGSObject(s_id+":user");cbx.gsPrefs=cbx.getGSObject("_:prefs");if(s_uo)cbx.gsUser.set("key",a.key.value),cbx.gsUser.set("nme",a.nme.value);else{var e=cbx.gsUser.get("key"),g=cbx.gsUser.get("nme"),h=cbx.gsUser.get("eml"),k=cbx.gsUser.get("pic");e&&(a.key.value=e);g&&(a.nme.value=g);a.eml&&h&&(a.eml.value=
h);a.pic&&k&&(a.pic.value=k);try{a.pic&&(a.pic.type="hidden"),a.eml&&(a.eml.type="hidden")}catch(l){}}window.onbeforeunload=function(){};window.onfocus=function(){cbx.notifyParent("focus");windowIsFocused=!0;parent===window&&updateFavicon()};window.onblur=function(){cbx.notifyParent("blur");windowIsFocused=!1};window.onkeydown=function(a){};var m=window;cbx.lp=Math.max(cbx.lp,1*m.lpid);m.nme&&a.nme.value==t1&&(a.nme.value=m.nme);m.eml&&a.eml&&a.eml.value==t5&&(a.eml.value=m.eml);m.onunload=function(){m=
cbx.$body=null};window.setTimeout(function(){initAudio(snuri)},1200);authBtnSetup("btnProfile",a.nme);profileBtnSetup();cbx.modBtn=makeButton("Approval","","Pending messages",function(){pop("modchan&n="+esc(cbx.$frm.nme.value)+"&k="+esc(cbx.$frm.key.value),320,480,0)},"btnModPop").hide();cbx.upd_tms();ar_reset();msgToolsUpdate();3==s_uo&&cbx.$frm.key.value?window.setTimeout(function(){cbx.xhr("getlvl",{json:1,n:cbx.$frm.nme.value,k:cbx.$frm.key.value},null,function(a,b){if(a){var c=JSON.parse(a);
cbx.updateUser(c)}})},500):(e=cbx.$frm.key.value,cbx.legacyGetLvlFromKey(e));s_on&2&&cbx.addTypingHandler(a.pst,function(a){cbx.presMgr.sendPing(a?"typing":"idle")});cbx.autoScroll(!0);cbx.listenParent();cbx.FP.hash(function(a){cbx.fp=a})};"undefined"===typeof JSON&&(window.JSON={parse:function(){},stringify:function(){}});
cbx.getGSObject=function(a,b){var c,d;try{var e=localStorage.getItem("cbx:"+a);e&&(d=JSON.parse(e))&&d.val&&(c=d.val)}catch(g){cbx.debug.log("[GS] get failed: "+g.name)}d||(d={});c||(c={});return{get:function(a){return c[a]},set:function(e,g){if(!c[e]||c[e]!==g||"object"===typeof g){c[e]=g;d.val=c;var l=(new Date).getTime()/1E3|0;d.ctime?d.mtime=l:d.ctime=l;b&&(d.ttl=1*b);try{localStorage.setItem("cbx:"+a,JSON.stringify(d))}catch(m){cbx.debug.log("[GS] set failed: "+m.name)}}},toString:function(){return JSON.stringify(c)}}};
cbx.notifyParent=function(a,b){if(!window.postMessage||window.parent===window)return!1;window.parent.postMessage(JSON.stringify({event:""+a,data:b,serial:s_no}),"*")};
cbx.listenParent=function(){window.onmessage=function(a){if(!a||!a.origin||null===a.origin.match(/\.cbox\.ws$/)&&null===a.origin.match(/cbox\.im$/))cbx.debug.log("Got wrong origin "+a.origin,"PARENT");else{var b={};try{b=JSON.parse(a.data)}catch(c){cbx.debug.log("Got bad JSON","PARENT")}a=b._call;var d=b.args;cbx.debug.log("Got call "+a,"PARENT");"ruready"===a&&cbx.notifyParent("ready");if("elemFromPoint"===a){d=document.elementFromPoint(d.x,d.y);if(null===d){cbx.notifyParent(a,null);return}cbx.notifyParent(a,
d.tagName+" "+d.className)}"setStyle"===a&&(cbx.setStyle(b.sel,b.prop,b.val),cbx.debug.log("GOT SETSTYLE FOR "+b.prop));"loadCSS"===a&&(cbx.loadCSS(window,"./?"+s_rq+"&sec=css&i="+b.which),cbx.debug.log("GOT loadCSS FOR "+b.which));"replaceCSS"===a&&(cbx.replaceCSS(b.cssText),cbx.debug.log("GOT replaceCSS"));"type"===a&&(a=cbx.$frm,a.pst.value==a.pst.x_placeholder&&(a.pst.value=""),a.pst.value=a.pst.value+" "+b.message,a.pst.focus())}};cbx.notifyParent("ready")};
cbx.debug={loadTime:(new Date).getTime(),history:[],log:function(a,b){var c=cbx.debug;c.history.push({time:(((new Date).getTime()-cbx.debug.loadTime)/1E3).toFixed(3),msg:a,group:b?b:""});50<c.history.length&&c.history.shift()},stringify:function(a){if("string"===typeof a||"number"===typeof a)return a;var b=[],c;for(c in a)b.push(c+": "+a[c]);return b.join(", ")}};
cbx.debugOverlay=function(){var a=null,b=overlay.create("Debug log","Debug"),c=function(){overlay.switchTo();a&&window.clearInterval(a);a=null},d=function(){overlay.switchTo(b)},e=function(){var a=["<b>Version:</b>  "+cbx.ver+" build "+cbx.build+" in "+document.compatMode+"<br>","<b>Namespace:</b>  "+s_phost+"-"+s_id+"-"+s_tid+" ("+s_no+") "+("https:"==document.location.protocol?"HTTPS":"")+"<br>","<b>User Agent:</b> "+navigator.userAgent+"<br>","<b>FP:</b> "+cbx.fp+"<br>","<b>Time:</b> "+(new Date).getTime()+
", srvtime: "+cbx.unixTime()+"<br>","<b>Prefs:</b> "+cbx.gsPrefs.toString()+"<br>","<b>User:</b> "+cbx.gsUser.toString()+"<br>","<b>LP ID:</b> "+cbx.lp+"<br>","<b>Scroll lock:</b> "+scrollFollow+"<br>","<b>ARMGR state:</b> "+cbx.arMgr.state+", upstream: "+cbx.arMgr.upstream+", wait: "+cbx.arMgr.backoff+"<br>","<b>WS/FL/LP/RP state:</b> "+wsconn.state+" / "+flconn.state+" / "+cbx.lpconn.state+" / "+cbx.repl.state+"<br>","<b>Repl:</b> client "+cbx.repl.clientID+"; slave of "+cbx.repl.masterID+"<br>",
"<b>Presence:</b> "+cbx.presMgr.state+"<br>","<b>LP:</b> "+cbx.debug.stringify(cbx.lpconn)+"<br>","<b>--- Log ---</b><br>"],c;for(c in cbx.debug.history){var e=cbx.debug.history[c];a.push(e.time+" ["+e.group+"] "+e.msg+"<br>")}b.body.innerHTML=a.join("")};return{update:e,show:d,hide:c,toggle:function(){b&&b.isVisible?c():(e(),d())},autorefresh:function(){c();a=window.setInterval(e,500);e();d()}}}();cbx.cmdHistory=[];cbx.cmdCursor=0;
cbx.cmdExec=function(a){if("//"!==a.substring(0,2))return!1;var b=cbx.$frm;b.pst.onkeydown=function(a){a=a||window.event;"INPUT"!==b.pst.tagName||!cbx.cmdHistory.length||38!=a.keyCode&&40!=a.keyCode||(38==a.keyCode&&cbx.cmdCursor+1<cbx.cmdHistory.length&&(cbx.cmdHistory[cbx.cmdCursor]=b.pst.value,b.pst.value=cbx.cmdHistory[++cbx.cmdCursor]),40==a.keyCode&&cbx.cmdHistory.length&&cbx.cmdCursor&&(cbx.cmdHistory[cbx.cmdCursor]=b.pst.value,b.pst.value=cbx.cmdHistory[--cbx.cmdCursor]),a.preventDefault&&
a.preventDefault())};a!==cbx.cmdHistory[0]&&(cbx.cmdHistory[0]=a,cbx.cmdHistory.unshift(""),10<cbx.cmdHistory.length&&cbx.cmdHistory.pop());cbx.cmdCursor=0;var c={error:function(){window.setTimeout(function(){throw Error("Debug error");},1)},debug:function(a){"watch"==a?cbx.debugOverlay.autorefresh():cbx.debugOverlay.toggle()},reload:function(a){window.location.reload(!0)},ping:cbx.doPing,loadcss:function(a){cbx.loadCSS(window,a)},loadsound:function(a){cbx.audio.setup(a)},sticky:function(a){},tetris:function(){var a=
window.open("","","width=400, height=600, resizable=yes");a.document.write('<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width, initial-scale=1.0"></head><body id="bdy" style="position:absolute;margin:0;width:100%;height:100%;"></body></html>');a.document.close();a.document.title="TETRIS!";var b=a.document.getElementById("bdy");a.onTetrisReady=function(c){c=new c(b);a.onresize=c.redraw;a.onblur=c.pause;a.onfocus=c.resume;c.start()};var c=a.document.createElement("script");
c.src="//static.cbox.ws/jsc/tetris.js?1";b.appendChild(c)},wordsearch:function(a){a=a||"";var b=cbx.gsUser.get("nme")||"";window.open("http://www.cbox.ws/games/wordsearch/?name="+esc(b)+"#"+esc(a),"","width=750, height=600, resizable=yes")},help:function(){var a=[],b;for(b in c)a.push(b);add_priv_post("[HELP]",a.join(", "))},pm:function(a,b){if(a||b)return!0;setStatus("Usage: //pm uid message<br>Or: //pm on|off")},colors:function(){cbx.colorPicker.toggle()},ignore:function(a){var b=cbx.gsUser.get("ignores")||
[];a?-1<b.indexOf(a)?(b.splice(b.indexOf(a),1),cbx.gsUser.set("ignores",b),setStatus("User "+a+" no longer ignored.","Okay")):(b.push(a),cbx.gsUser.set("ignores",b),setStatus("User "+a+" ignored","Okay")):(a="Not ignoring anyone yet. Use: //ignore username. ",b.length&&(a="Currently ignoring: "+b.join(", ")),setStatus(a,"Okay"))},menu:function(a){cbx.notifyParent("menu",a)},halt:function(){},quote:function(a){var b=new XMLHttpRequest;b.onload=function(a){try{var c=JSON.parse(b.responseText);for(a=
0;a<c.length;a++){var d=[Math.pow(2,32)+Math.floor(1E4*Math.random()),(new Date).getTime()/1E3|0,"Date string",c[a].title,1,c[a].link,c[a].content,"",0,1234,""].join("\t");cbx.parseMsg(d)}}catch(e){}};b.open("GET","http://quotesondesign.com/wp-json/posts?filter[orderby]=rand&filter[posts_per_page]="+(a||1)+"&cachebust="+Math.random());b.send()},quoteloop:function(){window.setInterval(c.quote,4E3)},trim:function(a){messages.trimTail(a||0)}};a=a.substring(2).split(" ");var d=a[0].toLowerCase();return c[d]?
!c[d].apply(this,a.slice(1)):(setStatus("Unknown command <b>"+d+"</b>."),!0)};cbx.loadCSS=function(a,b){var c=a.document.getElementsByTagName("head")[0],d=a.document.createElement("link"),e=c.getElementsByTagName("link"),g;for(g in e)"text/css"===e[g].type&&c.removeChild(e[g]);d.setAttribute("rel","stylesheet");d.setAttribute("type","text/css");d.setAttribute("href",b);c.appendChild(d);window.setTimeout(function(){cbx.rsz(!0)},50)};
cbx.replaceCSS=function(a){(function(b){for(var c=0;c<b.document.styleSheets.length;c++){var d=b.document.styleSheets[c];!d.href||0>d.href.indexOf("cbox")||(d.disabled=!0)}c=b.document.getElementById("__style");c||(d=b.document.getElementsByTagName("head")[0],c=b.document.createElement("style"),c.type="text/css",c.id="__style",d.insertBefore(c,d.firstChild));c.innerHTML=a})(window);window.setTimeout(function(){cbx.rsz(!0)},50)};
cbx.setStyle=function(a,b,c){var d=[];if(a&&b){var e=new RegExp("^"+a+"$","ig");(function(a){for(var h=0;h<a.document.styleSheets.length;h++){var k=a.document.styleSheets[h];if(k.href&&!(0>k.href.indexOf("cbox"))){if(k.cssRules&&k.cssRules.length){d=k.cssRules;break}if(k.rules&&k.rules.length){d=k.rules;break}}}for(h=0;h<d.length;h++)d[h]&&d[h].selectorText&&d[h].selectorText.match(e)&&(d[h].style[b]=c)})(window);window.setTimeout(function(){cbx.rsz(!0)},50)}};
cbx.rpcProcess=function(a,b){if("string"===typeof a&&a.length){var c=a.split("\n");window.setTimeout(function(){cbx.repl.sendmessage(a)},0);for(var d={upstream:function(a){cbx.arMgr.setUpstream(a)},del:function(a){cbx.proc_rpc_del(a)},updusrcnt:function(a){cbx.aonliners(a)},ping:function(a){a&&add_priv_post("[PING]","Ping reply (WS): "+Math.round((new Date).getTime()-1*a)+" ms")},pm:function(a){a.split("-")[1]!==cbx.gsUser.get("uid")?(cbx.debug.log("Ignoring non-target PM "+a),e=1):(cbx.debug.log("Sent mark "+
a),cbx.xhr("mark",null,{pm:a}))},mark:function(a){cbx.debug.log("Received mark for "+a);cbx.msgSetStatus(a,2)},typing:function(a){setTypingStatus(a)}},e=0,g=0;g<c.length;g++){var h=c[g];if(!(1>h.length)){var k=[];"<"==h.substring(0,1)&&(k=h.substring(1).split("="));0<k.length?d[k[0]]?d[k[0]].apply(this,k.slice(1)):b&&b(k[0],k[1]):e?e--:(cbx.parseMsg(h),msgToolsUpdate(),cbx.upd_tms())}}}};
cbx.doPing=function(){var a=(new Date).getTime(),b=null;4===wsconn.state&&(b={ping:a,cid:wsconn.id,chash:wsconn.hash});cbx.xhr("ar",b,null,function(b,d){if(!b||d)"L-timeout"==d?setStatus("Ping timeout"):setStatus(d);else{var e=(new Date).getTime()-a;add_priv_post("[PING]","Ping reply (XHR): "+Math.round(e)+" ms")}},5E3);add_priv_post("[PING]","Ping sent")};var relax=!1;
window.do_refresh=function(a){cbx.autoScroll(!0);if(relax)return window.setTimeout(function(){a||setStatus(t10,"Okay")},500),!1;relax=!0;window.setTimeout(function(){relax=!1},1E4);cbx.xhr("ar",{p:cbx.lp,c:cbx.unixTime()},null,function(b,c){setStatus();a||(!b||c?setStatus(c):cbx.aj_proc(b)||setStatus(t10,"Okay"))});return!1};
window.do_post=function(){var a=cbx.$frm,b=a.pst.value;if(cbx.cmdExec&&cbx.cmdExec(b))return cbx.setInputMode(),!1;if(!function(){return b&&b!=a.pst.x_placeholder?s_uo?!0:a.nme.value&&a.nme.value!=a.nme.x_placeholder?a.eml?""!=a.eml.value&&a.eml.value!=a.eml.x_placeholder&&0>=a.eml.value.lastIndexOf(".")&&0>=a.eml.value.lastIndexOf("@")?(setStatus(t6),a.eml.focus(),!1):!0:!0:(setStatus(t2),a.nme.focus(),!1):(setStatus(t4),a.pst.focus(),!1)}()||a.sub.disabled)return!1;overlay.switchTo();cbx.autoScroll(!0);
cbx.setInputMode();for(var c=1E5*Math.random()|0,d={aj:cbx.ver,lp:cbx.lp,pst:b,fp:cbx.fp,lid:c},e="nme eml key ekey fkey pic auth captme capword caphash".split(" "),g=0;g<e.length;g++){var h=e[g];!a[h]||""===a[h].value||"eml"==h&&a[h].value==t5||(d[h]=a[h].value)}sendBuffer.add(d,c);a.pst.focus();return!1};
var sendBuffer=function(){function a(a){return String(a).replace(/[&<>"'\/]/g,function(a){return c[a]})}var b=[],c={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"},d="idle",e=1,g=function(){if(b.length&&"idle"==d){var a=b.shift();d="sending";cbx.xhr("submit",null,a,function(c,l){d="sent";c=c||"";var m=c.split("\n")[0].split("\t");if(!c||m[0]||l){if(f.pst.value==t3||""==f.pst.value)f.pst.value=a.pst;setStatus(m[0]||l,l?"Error":"Warn");if(l){d="error";window.setTimeout(function(){d=
"idle";g()},2E3*e);e++;return}}else e=1,cbx.gsUser.set("nme",f.nme.value),f.eml&&cbx.gsUser.set("eml",f.eml.value),f.pic&&cbx.gsUser.set("pic",f.pic.value);b.length?(d="waiting",window.setTimeout(function(){d="idle";g()},250)):d="idle";cbx.aj_proc(c)})}};return{add:function(c){b.push(c);insertMessage({id:"L"+c.lid,unixtime:0,datestr:"",namehtml:a(c.nme),imgurl:c.pic,exturl:c.eml,msghtml:a(c.pst),isLocal:!0});g()}}}();
cbx.msgSetStatus=function(a,b){var c=messages.getById(a);if(c){for(var d=["","Sent","Delivered"],e=c.className.split(/\s+/),g=[d[b]],h=0;h<e.length;h++)e[h]!==d[b]&&g.push(e[h]);c.className=g.join(" ")}};
var ovrCaptcha=overlay.create("Captcha","Captcha"),showCaptcha=function(){overlay.switchTo(ovrCaptcha);cbx.xhr("captcha",{xhr:1},null,function(a,b){ovrCaptcha.body.innerHTML=a;var c=document.getElementById("cthash"),d=document.getElementById("ctinput"),e=document.getElementById("cttme"),g=document.forms.cbox;if("undefined"===typeof g.caphash){var h=document.createElement("input");h.name="caphash";h.type="hidden";g.appendChild(h);h=document.createElement("input");h.name="captme";h.type="hidden";g.appendChild(h);
h=document.createElement("input");h.name="capword";h.type="hidden";g.appendChild(h)}g.caphash.value=c.value;g.captme.value=e.value;g.capword.value=d.value;d.focus();d.onkeyup=function(){g.capword.value=d.value};d.onkeydown=function(a){a=a||window.cbm.event;13==(a.keyCode||a.which)&&window.do_post()}})};
cbx.aj_proc=function(a){var b=a.split("\n"),c=b[0].split("\t");if(!a)return!1;for(a=b.length-1;0<a;a--)cbx.parseMsg(b[a]);0<1*c[1]&&cbx.aonliners(c[1]);c[3]&&cbx.legacyGetLvlFromKey(c[3]);c[2]&&(a=Math.round(1*c[2]-(new Date).getTime()/1E3))&&cbx.gsPrefs.set("timeDelta",a);c[5]&&(cbx.gsUser.set("lpid",Math.max(c[5],cbx.gsUser.get("lpid"))),cbx.msgSetStatus(c[5],1));"NEED_CAPTCHA"==c[6]&&showCaptcha();b.length-1&&(cbx.upd_tms(),msgToolsUpdate());return b.length-1};
cbx.updateUser=function(a){cbx.debug.log("Got user data: "+JSON.stringify(a),"UDATA");if(a&&"object"===typeof a){"key"in a&&(cbx.$frm.key.value=a.key,cbx.gsUser.set("key",a.key));"nme"in a&&a.nme&&(cbx.$frm.nme.value=a.nme,cbx.gsUser.set("nme",a.nme));"url"in a&&a.url&&(cbx.$frm.eml&&(cbx.$frm.eml.value=a.url),cbx.gsUser.set("eml",a.url));"pic"in a&&a.pic&&(cbx.$frm.pic&&(cbx.$frm.pic.value=a.pic),cbx.gsUser.set("pic",a.pic));if("uid"in a){var b=cbx.gsUser.get("uid");cbx.gsUser.set("uid",a.uid);a.uid!=
b&&cbx.presMgr.sendPing()}"lvl"in a&&(b=cbx.gsUser.get("lvl"),cbx.gsUser.set("lvl",a.lvl),a.lvl!=b&&msgToolsUpdate())}};cbx.legacyGetLvlFromKey=function(a){cbx.updateUser({key:a});if(!s_uo){var b=cbx.gsUser.get("lvl")||1;a&&(b=1*a.substring(a.length-1,a.length),cbx.debug.log("Got lvl "+b+" from key","DPRKEY"));cbx.updateUser({lvl:b})}};window.ar_reset=function(){cbx.debug.log("ar_reset called");s_ar&&!cbx.arMgr.state&&cbx.arMgr.run();!s_on&&!s_pm||cbx.presMgr.state||cbx.presMgr.run()};
cbx.presMgr={state:0,ival:9E4,minIval:1E4,lastPingTme:0,sendPing:function(a){a={state:a||"online",k:cbx.$frm.key.value,rcid:cbx.arMgr.upstream||""};s_av&&cbx.$frm.pic.value&&(a.pic=cbx.$frm.pic.value);cbx.debug.log("Sending "+JSON.stringify(a),"PRES");cbx.presMgr.lastPingTme=(new Date).getTime();cbx.xhr("users",null,a,function(a,c){cbx.presMgr.state=!a||c?1:3})},run:function(){cbx.presMgr.state=1;var a=function(){var a=(new Date).getTime(),c=cbx.presMgr.lastPingTme;c&&a-c<cbx.presMgr.minIval?cbx.debug.log("Throttled",
"PRES"):cbx.presMgr.sendPing()};window.setTimeout(function(){cbx.presMgr.state=2;cbx.debug.log("Starting","PRES");a();window.setInterval(a,cbx.presMgr.ival)},8E3)}};
cbx.arMgr={state:0,backoff:2E3,lpIval:null,tmr:null,upstream:null,setUpstream:function(){},run:function(){cbx.arMgr.state=1;var a=function(){cbx.arMgr.backoff=Math.min(36E4,Math.floor(cbx.arMgr.backoff*(1.5+Math.random())))},b=function(){cbx.arMgr.backoff=Math.floor(1E3*(1.5+Math.random()))},c=function(a){cbx.debug.log(a,"ARMGR")},d=function(a,b){c(cbx.arMgr.state+"->"+a+" "+b);a!=cbx.arMgr.state&&(cbx.arMgr.state=a,3<=a&&cbx.xhr("ar",{p:window.lpid,c:cbx.unixTime()},null,function(a,b){a&&!b&&cbx.aj_proc(a)}))},
e=function(a,b){null!==cbx.arMgr.tmr&&(window.clearTimeout(cbx.arMgr.tmr),cbx.arMgr.tmr=null);a&&(cbx.arMgr.tmr=window.setTimeout(function(){c("Timer fired");a()},b))};cbx.arMgr.lpIval&&(window.clearInterval(cbx.arMgr.lpIval),cbx.arMgr.lpIval=null);cbx.arMgr.lpIval=window.setInterval(function(){3<=cbx.arMgr.state?cbx.lpStop():cbx.lpStart()},15E3);var g=cbx.arMgr.setUpstream=function(a){cbx.arMgr.upstream!==a&&(cbx.arMgr.upstream=a,cbx.presMgr.sendPing())},h=!1,k=function(){d(2,"Attempting WS");a();
e(h?k:l,1E4+cbx.arMgr.backoff);cbx.wsconn.onstatechange=function(){2===cbx.arMgr.state&&4===cbx.wsconn.state?(d(4,"WS connected"),g(wsconn.id+"_"+wsconn.hash),b(),e(function(){h=!0;c("Locking WS")},3E4)):4===cbx.arMgr.state&&0==cbx.wsconn.state&&(d(0,"WS disconnected. Retrying in "+cbx.arMgr.backoff),cbx.wsconn.onstatechange=null,e(k,cbx.arMgr.backoff))};wsStart(window.wsuri)},l=function(){d(2,"Attempting FL");a();e(k,1E4+cbx.arMgr.backoff);cbx.flconn.onstatechange=function(){2===cbx.arMgr.state&&
4===cbx.flconn.state?(d(4,"FL connected"),g(flconn.id+"_"+flconn.hash),b(),e(null)):4===cbx.arMgr.state&&0==cbx.flconn.state&&(d(0,"FL disconnected"),cbx.flconn.onstatechange=null,e(l,cbx.arMgr.backoff))};startFlashRelay()};(function(){d(1,"Attempting Repl");e(k,5E3);cbx.repl.onstatechange=function(){var a=4===cbx.arMgr.state||2===cbx.arMgr.state||0===cbx.arMgr.state;a&&4===cbx.repl.state?d(4,"Repl connected; have upstream"):1===cbx.arMgr.state&&4===cbx.repl.state?(d(3,"Repl connected"),e(null),cbx.repl.onmessage=
function(a){cbx.rpcProcess(a)}):a&&4>cbx.repl.state?d(4,"Repl disconnected; have upstream"):3===cbx.arMgr.state&&4>cbx.repl.state&&(d(1,"Repl disconnected"),cbx.repl.onmessage=null,e(k,5E3))};cbx.repl.start(s_id+"_"+s_tid)})();window.setInterval(function(){var a=4===wsconn.state?wsconn:null;(a=4===flconn.state?flconn:a)&&cbx.repl.sendmessage("<upstream="+a.id+"_"+a.hash+"\n")},2E3)}};cbx.lpconn={enabled:!1,state:0,tmeLastRequest:0,curWait:0,lastErr:null,numMessages:0,numRequests:0};
cbx.lpStop=function(){cbx.lpconn.enabled=!1};cbx.lpStart=function(){var a=cbx.lpconn.enabled;cbx.lpconn.enabled=!0;a||cbx.lpLoop()};
cbx.lpLoop=function(){var a=function(a){cbx.debug.log(a,"LP-XHR")},b=cbx.lp;if(0<cbx.lpconn.state)return!1;cbx.lpconn.state=1;cbx.lpconn.numRequests++;cbx.lpconn.tmeLastRequest=(new Date).getTime();var c=null;window.XDomainRequest?(c=new XDomainRequest,a("Using XDR")):c=new XMLHttpRequest;var d=!1,e=function(b){d||(d=!0,cbx.lpconn.lastErr=null,b=(new Date).getTime()-cbx.lpconn.tmeLastRequest,cbx.lpconn.curWait=Math.max(2E3,8E3-b)+Math.floor(5E3*Math.random()),window.setTimeout(function(){cbx.lpconn.state=
0;cbx.lpconn.enabled&&cbx.lpLoop()},cbx.lpconn.curWait),(b=c.responseText)?"1"!==b.substring(0,1)?(cbx.lpconn.lastErr="Badstatus",a("Done: got bad status char")):(b=b.substring(1)||"",cbx.rpcProcess(b),cbx.lpconn.numMessages++):(cbx.lpconn.lastErr="Empty",a("Done: got empty response")))};c.onload=e;c.onerror=e;c.onreadystatechange=function(){4==c.readyState&&e()};c.timeout=32E4;b=lpuri+"?id="+s_id+"_"+s_tid+"&ev="+b;c.open("GET",b);window.setTimeout(function(){c.send()},0);a("GET "+b);return!0};
cbx.flash={obj:null,readyState:0,load:function(){window.fl_ready=function(){cbx.flash.readyState=2;cbx.flash.onready()};window.fl_gotconn=function(){cbx.flash.onopen()};window.fl_pclosed=function(){cbx.flash.onclose()};window.fl_gotmsg=function(a){cbx.flash.onmessage(a)};cbx.flash.obj=loadSWF("ARswf",window.fluri);cbx.flash.readyState=1},open:function(){cbx.flash.obj&&1<cbx.flash.readyState?cbx.flash.obj.doConn():cbx.debug.log("Open called on not-ready Flash!","FLA")},close:function(){cbx.flash.obj&&
1<cbx.flash.readyState?cbx.flash.obj.endConn():cbx.debug.log("Close called on not-ready Flash!","FLA")},onready:function(){},onmessage:function(a){},onopen:function(){},onclose:function(){}};
var flconn={id:null,hash:null,pool:null,state:0,numAttempts:0,numCommands:0,numMessages:0,onstatechange:null},startFlashRelay=function(){var a=null,b=function(a){if(a!=flconn.state&&(flconn.state=a,flconn.onstatechange))flconn.onstatechange()},c=function(b,c){null!=a&&(window.clearTimeout(a),a=null);b&&(a=window.setTimeout(function(){cbx.debug.log("Timer fired","FLAR");b()},c))},d=function(){cbx.debug.log("Failed","FLAR");flconn.pool=null;flconn.id=null;flconn.hash=null;b(0);c(null)};cbx.flash.onclose=
function(){cbx.debug.log("Closed","FLAR");b(0);d()};var e=function(){flconn.curAttempts++;cbx.debug.log("Opening","FLAR");c(d,1E4);cbx.flash.open();b(1)};cbx.flash.onopen=function(){b(2);c(d,1E4)};cbx.flash.onmessage=function(a){flconn.numMessages++;4===flconn.state&&c(d,18E4);cbx.rpcProcess(a,function(a,e){flconn.numCommands++;"pool"==a&&(cbx.debug.log("Registered","FLAR"),flconn.pool=e,c(d,18E4),b(4));"hash"==a&&(flconn.hash=e);"id"==a&&(flconn.id=e);flconn.id&&flconn.hash&&2==flconn.state&&(c(d,
1E4),b(3),cbx.debug.log("Registering","FLAR"),cbx.xhr("relayreg",{cid:flconn.id,chash:flconn.hash,m:"fl"}))})};0===cbx.flash.readyState?(cbx.debug.log("Loading","FLAR"),cbx.flash.onready=function(){cbx.debug.log("Loaded","FLAR");e()},cbx.flash.load()):e()};cbx.flconn=flconn;var wsconn={id:null,hash:null,pool:null,state:0,tmeAttempted:0,tmeOpened:0,tmeHalfEst:0,tmeCompleted:0,numAttempts:0,curAttempts:0,curBackoff:0,numCommands:0,numMessages:0,log:[],onstatechange:null,socket:null,tmr:null};
cbx.wsconn=wsconn;
var wsStart=function(a){var b=function(a){cbx.debug.log(a,"WS")},c=function(a){if(a!=wsconn.state&&(wsconn.state=a,wsconn.onstatechange))wsconn.onstatechange()},d=function(a,c){null!==wsconn.tmr&&(window.clearTimeout(wsconn.tmr),wsconn.tmr=null);a&&(wsconn.tmr=window.setTimeout(function(){b("Timer fired");a()},c))},e=function(a){var b={"\\\\":"\\","&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#039;":"'"};return a.replace(/(\\\\)|(&amp;)|(&lt;)|(&gt;)|(&quot;)|(&#039;)/g,function(a){return b[a]})};try{wsconn.tmeAttempted=
(new Date).getTime();wsconn.numAttempts++;wsconn.curAttempts++;b("OPENING "+a);var g=function(){d(null);0<wsconn.state&&(h.close(),c(0));wsconn.id=null;wsconn.hash=null;wsconn.pool=null};c(1);d(g,1E4);wsconn.socket&&(wsconn.socket.onclose=function(){},wsconn.socket.onerror=function(){},wsconn.socket.close(),wsconn.socket=null);wsconn.socket=new WebSocket(a);var h=wsconn.socket;h.onopen=function(){c(2);b("OPEN");d(g,5E3);wsconn.tmeOpened=(new Date).getTime();wsconn.curAttempts=0};h.onclose=function(a){b("CLOSE "+
(a.wasClean?"CLEAN":"UNEXPECTED")+" ("+a.code+") "+a.reason);c(0);g()};h.onerror=function(a){b("ERROR");g()};h.onmessage=function(a){wsconn.numMessages++;4===wsconn.state&&d(g,18E4);a=e(a.data);cbx.rpcProcess(a,function(a,e){wsconn.numCommands++;"pool"==a&&(b("Registered downlink"),c(4),wsconn.pool=e,d(g,18E4),wsconn.tmeCompleted=(new Date).getTime());"hash"==a&&(wsconn.hash=e);"id"==a&&(wsconn.id=e);null!==wsconn.id&&null!==wsconn.hash&&2===wsconn.state&&(b("Registering downlink"),c(3),d(g,5E3),
wsconn.tmeHalfEst=(new Date).getTime(),cbx.xhr("relayreg",{cid:wsconn.id,chash:wsconn.hash,m:"ws"}))})}}catch(k){return c(0),b("Caught exception: "+k.message),!1}};cbx.aonliners=function(a){a*=1;cbx.onlinerBtn&&cbx.onlinerBtn.text(a);cbx.notifyParent("onliners",a)};
var initOnliners=function(){var a=overlay.create("Online users","Users"),b=document.getElementById("users"),c=null,d=!1,e=!1,g=function(){!d&&e&&(null!==c&&(window.clearTimeout(c),c=null),d=!0,cbx.xhr("onliners",{xhr:1},null,function(h,k){d=!1;e&&(c=window.setTimeout(g,1E4));var l=a.isVisible?a.body:b;l.innerHTML=h;for(var l=l.querySelectorAll("img.pic"),m=0;m<l.length;m++)(function(a){a.onclick=function(){showFullImage(a.src)}})(l[m])}))};window.setInterval(function(){a.isVisible||b&&b.clientWidth?
e||(e=!0,g()):e=!1},2E3);cbx.onlinerBtn=makeButton("Users",window.onu,"Users online",function(){if(a.isVisible)overlay.switchTo();else{var c=!1;b&&b.clientWidth||(c=!0);c&&overlay.switchTo(a)}},"btnOnliners").enable()},Emotes=function(){var a=[],b=null;return{enqueueAll:function(b){b=b.querySelectorAll(".imgBox.Defer");for(var d=0;d<b.length;d++)b[d].getAttribute("data-state")||(a.push(b[d]),b[d].setAttribute("data-state","queued"))},load:function(){null!==b&&(window.clearTimeout(b),b=null);b=window.setTimeout(function(){for(var b=
0;b<a.length;b++){var d=a[b];if(d&&"queued"===d.getAttribute("data-state")){var e=d.getBoundingClientRect();e.top>=document.documentElement.clientHeight||0>e.bottom||(e=new Image,e.src=d.getAttribute("data-url"),d.setAttribute("data-state","loading"),d.appendChild(e),a.splice(b--,1))}else a.splice(b--,1)}},400)}}}(),scrollFollow=!0,scrollHeightPrev=null,keepScrollTmr=null,keepScrollCnt=0,loadingOlderMsgs=!1,noMoreOlder=!1,isPaused=!1,onScrollFunc=function(){var a=this.clientHeight||Infinity,b=this.scrollTop||
0,c=this.scrollHeight,a=s_bs&&b+a>c-10||!s_bs&&10>b;!scrollFollow&&a?scrollFollow=!0:(scrollFollow&&!a&&(scrollFollow=!1,cbx.refreshBtn.icon(s_bs?"DoubleDown":"DoubleUp").onclick(function(){cbx.autoScroll(!0);return!1}).enable()),Emotes.load())};
cbx.autoScroll=function(a){var b=document.getElementById("messages");b?(a=a||!1,window.setTimeout(function(){null!==keepScrollTmr&&(window.clearTimeout(keepScrollTmr),keepScrollTmr=null);"addEventListener"in b?b.removeEventListener("scroll",onScrollFunc,{passive:!0}):b.onscroll=null;a&&(scrollFollow=!0);scrollFollow&&!isPaused&&cbx.refreshBtn.icon("Circle").disable();cbx.rsz();window.onresize=cbx.rsz;if(unreadMessages[0]){var c=document.getElementById("messages").getBoundingClientRect();do{var d=
unreadMessages[0].getBoundingClientRect();if(!d||!d.top&&!d.bottom)break;if(s_bs&&d.bottom>=c.bottom)break;if(!s_bs&&d.top<=c.top)break;unreadMessages.shift().classList.remove("Unread")}while(unreadMessages[0])}c=unreadMessages.length||0;c+=droppedMessages;cbx.refreshBtn.text(c||"");c=Math.max(document.body&&document.body.scrollHeight,b&&b.scrollHeight,document.documentElement&&document.documentElement.scrollHeight);scrollFollow?b.scrollTop=s_bs?c:0:!s_bs&&scrollHeightPrev&&c-scrollHeightPrev&&(b.scrollTop+=
c-scrollHeightPrev);c!==scrollHeightPrev&&cbx.notifyParent("heightchange",c);scrollHeightPrev=c;window.setTimeout(function(){"addEventListener"in b?b.addEventListener("scroll",onScrollFunc,{passive:!0}):b.onscroll=onScrollFunc},50);keepScrollTmr=window.setTimeout(cbx.autoScroll,500);var e=document.getElementById("olderMsgs");e&&(c=document.getElementById("messages").getBoundingClientRect(),d=e.getBoundingClientRect(),!(s_bs&&d.top>c.top||!s_bs&&d.bottom<c.bottom)||loadingOlderMsgs||noMoreOlder||(e.innerHTML=
"Loading...",loadingOlderMsgs=!0,cbx.xhr("archive",{xhr:1,i:messages.getOldestID()},null,function(a,c){loadingOlderMsgs=!1;if(c||!a)e.innerHTML="No more messages",noMoreOlder=!0;else{var d=b.scrollHeight,l=b.scrollTop;e.insertAdjacentHTML(s_bs?"afterend":"beforebegin",a);loadingOlderMsgs=!1;e.innerHTML="&nbsp;";s_bs&&(b.scrollTop=l+(b.scrollHeight-d));scrollHeightPrev=b.scrollHeight;msgToolsUpdate();cbx.upd_tms()}})));scrollFollow&&!loadingOlderMsgs&&b.scrollHeight>3*b.clientHeight&&(messages.trimTail(3*
s_mp),noMoreOlder=!1);!scrollFollow&&!loadingOlderMsgs&&500<messages.getCount()&&(cbx.refreshBtn.icon("CirclePlay").onclick(function(){isPaused=!1;droppedMessages=0;do_refresh(!0);return!1}).enable(),isPaused=!0)},50)):cbx.debug.log("No messages container","SCROLL")};
cbx.rsz=function(a){a=cbx.$frm;var b=document.documentElement.clientWidth,c=document.documentElement.clientHeight;if(c&&b){cbx.rszH=c;cbx.rszW=b;var d=a.clientHeight;a=function(a,b){a.style[b]=a.scrollHeight<=c-d?"auto":"0px"};var b=document.getElementById("overlay"),e=document.getElementById("messages"),g=document.getElementById("users"),h=document.getElementById("typingStatus");overlay.setFull(b.scrollHeight>=c-d);s_ft?(e.style.top=g.style.top=b.style.top=h.style.top=d+"px",a(e,"bottom"),a(b,"bottom"),
a(g,"bottom")):(e.style.bottom=g.style.bottom=b.style.bottom=h.style.bottom=d+"px",a(e,"top"),a(b,"top"),a(g,"top"))}else cbx.debug.log("Bailed","RSZ")};
window.pop=function(a,b,c,d){cbx.debug.log("Opening pop "+a+" at "+b+" x "+c);var e=window.open("./?"+s_rq+"&sec="+a,"cb"+s_id+a.substring(0,3),"width="+b+",height="+c+",toolbar=no,scrollbars="+d+",status=no,resizable=yes");window.setTimeout(function(){var a=screen.width,d=screen.height,k=screen.availLeft||0,l=screen.availTop||0;e.focus();window.setTimeout(function(){e.moveTo(k+a/2-b/2-100,l+d/2-c/2)},50)},10);return e};function esc(a){return encodeURIComponent(a)}
cbx.unixTime=function(){var a=cbx.gsPrefs.get("timeDelta")||0;return Math.round((new Date).getTime()/1E3)+a};
cbx.xhr=function(a,b,c,d,e){var g=null,h=null;d=d||function(){};e=e||2E4;var k=function(a){var b=[],c;for(c in a)b.push(c+"="+esc(a[c]));return b.join("&")},l=function(a){a=a||"L-timeout";window.clearTimeout(h);null!==g&&(g.onreadystatechange=function(){},g.abort(),g=null);d(null,a)},m=["./?sec="+a,s_rq,"_v="+cbx.ver];(b=k(b))&&m.push(b);m=m.join("&");if(window.XMLHttpRequest)g=new XMLHttpRequest;else if(window.ActiveXObject)try{g=new ActiveXObject("Msxml2.XMLHTTP")}catch(n){try{g=new ActiveXObject("Microsoft.XMLHTTP")}catch(p){}}g||
l(t14+"L-JS");var q="-";g.onreadystatechange=function(){if(4==g.readyState){q=g.status;window.clearTimeout(h);var a=" ("+q+")";if(0==g.status)return l(t14+"L-network"+a);if(200!=g.status)return l(t14+"R-server"+a);var b=g.responseText,c=b.substring(0,1),b=b.substring(1);if("1"!=c&&"0"!=c)return l(t14+"R-chksum"+a);if("0"==c)return l(""+b);d(b,null)}};g.onerror=function(a){l("Internet connection failure.")};h=window.setTimeout(l,e);e=c?"POST":"GET";g.open(e,m,!0);g.setRequestHeader("Accept","*/*");
g.responseType="text";cbx.debug.log(e+" "+a,"XHR");c?(g.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),g.send(k(c))):g.send();return!0};
var tmrStatus=null,tmrAnim=null,statusBtn=null,setStatus=function(a,b){var c=document.getElementById("barNotice"),d=document.getElementById("barDefault"),e=document.getElementById("barTitle");cbx.debug.log(a,"STATUS");null!==tmrStatus&&(window.clearTimeout(tmrStatus),tmrStatus=null);null!==tmrAnim&&window.clearInterval(tmrAnim);statusBtn||(statusBtn=makeButton("Cancel Right","","",function(){setStatus()},"btnStatus").enable());if(a){statusBtn.text(a);c.className="bar "+(b?b:"Warn");d.className="bar Hide";
e.className="bar Hide";var g=document.querySelector("#btnStatus span"),h=0;g.scrollWidth>g.clientWidth&&(tmrAnim=window.setTimeout(function(){var b=function(){statusBtn.text(a.substring(h));h+=1;g.scrollWidth>g.clientWidth?tmrAnim=window.setTimeout(b,200):(h=0,tmrAnim=window.setTimeout(function(){statusBtn.text(a);tmrAnim=window.setTimeout(b,1E3)},1E3))};b()},1E3));cbx.autoScroll()}else c.className="bar Hide",overlay.getCurrent()?e.className="bar":d.className="bar"},setTypingStatus=function(){var a=
null;return function(b){var c=document.getElementById("typingStatus");c.innerHTML=b?b:"";null!==a&&(window.clearTimeout(a),a=null);b?(c.className="Show",a=window.setTimeout(function(){c.className="SlowHide"},5E3)):c.className=""}}();cbx.parseMsg=function(a){if(a=msgFromTSF(a))if(a=insertMessage(a))parseMsgTags(a),cbx.notifyParent("message",null),cbx.newMessageAsync()};
var parseMsgTags=function(a){if(a.getElementsByClassName){var b=a.getElementsByClassName("atname");a=a.getElementsByClassName("bbUser");if(b||$bbUser){var c="";cbx.$frm.nme.value&&(c=cbx.$frm.nme.value.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"));for(var d=new RegExp("^@?"+c+"$"),e=0;e<b.length;e++){var g=b[e];if(!c)break;if(g&&g.textContent&&g.textContent.match(d)){audioPlay("volTag");break}}for(e=0;e<a.length;e++)if(g=a[e],g.getAttribute&&cbx.gsUser.get("uid")&&g.getAttribute("data-uid")==cbx.gsUser.get("uid")){audioPlay("volTag");
break}}}};cbx.newMessageTmr=null;cbx.newMessageAsync=function(){cbx.newMessageTmr||(audioPlay("volAll"),titleflash(),cbx.newMessageTmr=window.setTimeout(function(){cbx.newMessageTmr=null},1E3))};
var add_priv_post=function(a,b){var c={id:-2,unixtime:cbx.unixTime(),datestr:"",namehtml:a,userlevel:0,exturl:"",msghtml:b,bad_flags:32};insertMessage(c);cbx.upd_tms()},msgFromTSF=function(a){a=a.split("\t");if(!a||7>a.length)return cbx.debug.log("Badly formed; ignoring","MSGTSF"),null;a={id:a[0],unixtime:a[1],datestr:a[2],namehtml:a[3],userlevel:a[4],exturl:a[5],msghtml:a[6],imgurl:a[7],bad_flags:a[8],uid:a[9],flaghtml:a[10],localID:a[11]};a.isRedirected=!!(a.bad_flags&16);a.isPrivate=!!(a.bad_flags&
32);a.isSticky=-1==a.id;a.isTemp=0==a.id;return a},messages={getCount:function(){return document.querySelectorAll("#messages > .msg").length},getById:function(a){return document.querySelector('#messages > .msg[data-id="'+a+'"]')},getAll:function(){return document.querySelectorAll("#messages > .msg")},getData:function(a){if(a){var b={};b.uid=a.getAttribute("data-uid");b.lvl=a.getAttribute("data-lvl");b.id=a.getAttribute("data-id");b.unixtime=1*a.getAttribute("data-time");b.isRedirected=!!a.getAttribute("data-redirected");
return b}},getOldestID:function(){var a=document.querySelectorAll("#messages > .msg");if(!a.length)return null;for(var b=Infinity,c=0;c<a.length;c++){var d=messages.getData(a[c]);d&&d.id&&1*d.id&&(b=Math.min(b,1*d.id))}return Math.max(b,0)},insertAtHead:function(a){var b=document.getElementById("msgHead");s_bs?b.parentElement.insertBefore(a,b):b.parentElement.insertBefore(a,b.nextSibling)},trimTail:function(a){var b=messages.getAll(),c=function(a){b[a]&&(b[a].nextSibling&&b[a].nextSibling.className&&
-1<b[a].nextSibling.className.indexOf("msgtools")&&b[a].parentElement.removeChild(b[a].nextSibling),b[a].parentElement.removeChild(b[a]),unreadMessages[0]===b[a]&&unreadMessages.shift())};if(s_bs){a=b.length-a;for(var d=0;d<a;d++)c(d)}else for(d=b.length-1;d>=a;d--)c(d)}},unreadMessages=[],droppedMessages=0,insertMessage=function(a){var b=function(a){cbx.debug.log(a,"MSG")};a.id>cbx.lp&&1*a.id&&(cbx.lp=a.id);var c=function(a){var b=[];if(a.isTemp||a.isSticky)return b.push('<div align="center">'+a.msghtml+
"</div>"),b.join("");s_av&&(a.imgurl?b.push('<img src="'+a.imgurl+'" class="pic">'):b.push('<span class="pic Empty"></span>'));s_sf&&b.push(a.flaghtml);a.isPrivate&&b.push('<div class="status" title="'+t15+'"></div>');a.isRedirected&&b.push('<div class="status" title="'+t26+'"></div>');1<s_dt&&b.push('<div class="dtxt" id="t'+a.unixtime+'" '+(s_rt?'dir="ltr"':"")+">"+a.datestr+"</div>");b.push("<div");1==s_dt&&b.push(' title="'+a.datestr+'"');b.push(' class="nme"');s_rt&&b.push(' dir="ltr"');b.push(">"+
a.namehtml+"</div>");s_ae&&a.exturl&&b.push('<a href="'+a.exturl+'" rel="noreferrer" target="_blank" class="nmeurl"></a>');b.push('<div class="body">'+a.msghtml+"</div>");return b.join("")},d=!1,e=messages.getById(a.id);e&&(d=!0,b("Got update for message "+a.id));a.localID&&(e=messages.getById("L"+a.localID))&&(d=!0,b("Got update for local message "+a.localID));var g=cbx.gsUser.get("ignores")||[];if(g.indexOf&&(-1<g.indexOf(a.uid)||-1<g.indexOf(a.namehtml)))return b("User in ignore list; ignoring"),
!1;if(a.msghtml){g=["msg"];a.isSticky&&g.push("Sticky");a.isTemp&&g.push("Temp");a.isPrivate&&g.push("Private");a.isRedirected&&g.push("Redirected");a.isLocal&&g.push("Sending");switch(a.userlevel){case "2":g.push("Reg");break;case "3":g.push("Mod");break;case "4":g.push("Adm");break;case "5":g.push("Bot")}e||(e=document.createElement("div"));if(!d&&isPaused)droppedMessages++,b("Paused; dropped");else{scrollFollow||d||(g.push("Unread"),unreadMessages.push(e));e.innerHTML=c(a);e.className=g.join(" ");
e.setAttribute("data-id",a.id);e.setAttribute("data-time",a.unixtime);e.setAttribute("data-uid",a.uid||0);e.setAttribute("data-lvl",a.userlevel||0);a.isRedirected&&e.setAttribute("data-redirected","true");if(d)b("Updated message "+a.id);else{if(c=document.getElementById("msgWelcome"))c.style.display="none";messages.insertAtHead(e);b("Inserted message "+a.id);cbx.autoScroll()}return e}}else b("Empty message; ignoring")},updTmsInt=null;
cbx.upd_tms=function(){if(3!=s_dt)return!0;for(var a=cbx.unixTime(),b=t16,c=[2592E3,604800,86400,3600,60,1],d=messages.getAll(),e=60,g=0;g<d.length;g++){var h=messages.getData(d[g]);if(h.unixtime){h=a-h.unixtime;0>h&&(h=0);60>h&&(h=5*Math.ceil(h/5));for(var e=Math.min(h,e),k=0;6>k;k++){var l=0;if(1<h/c[k]){h/=c[k];l=10-2*k;break}}if(k=d[g].querySelector(".dtxt"))k.title||(k.title=k.innerHTML),h=Math.round(h),k.innerHTML=t24.replace("%d",h).replace("%s",b[1==h?l:l+1])}}null===updTmsInt&&(updTmsInt=
window.setInterval(cbx.upd_tms,1E3*Math.max(5,e)))};
cbx.colorPicker=function(){var a=null,b="262626 c00000 e16900 e1c700 669f00 00a198 004c92 5f03bb 9c026e 444444 DE1A10 FF870F FFE500 84BD00 00BFB6 006AB0 7D21D9 BA208C 808080 ff564c ffc34b ffff3c c0f93c 3cfbf2 3ca6ec b95dff f65cc8".split(" "),c=function(){if(a)return a;a=overlay.create("Colour picker","colorPicker");for(var c=['<table border="0" cellpadding="0" cellspacing="0" width="100%" style="cursor:pointer">'],g=0,h=1;g<b.length;g++)0===g%9&&(c[h++]="<tr>"),c[h++]='<td style="height: 2em; width: '+
100/9+"%; background-color: #"+b[g]+';">&nbsp;</td>',8===g%9&&(c[h++]="</tr>");c[h++]="</table>";a.body.innerHTML=c.join("");a.body.onclick=function(a){a.target&&"TD"==a.target.tagName&&(cbx.setInputMode("^#"+b[9*a.target.parentElement.rowIndex+a.target.cellIndex]),d())};return a},d=function(){var a=c();a&&overlay.switchTo(a.isVisible?null:a)};return{toggle:d}}();
var insertAtCaret=function(a){var b=document,c=b.forms[0].pst,d,e,g;c.value==t3&&(c.value="");b.selection?(g=b.selection.createRange(),null!=g.text&&(g.text="\u0001"),e=d=c.value.indexOf("\u0001"),-1==e&&(e=d=c.value.length),g.moveStart("character",-1),g.text=""):"null"!=c.selectionStart&&(d=c.selectionStart,e=c.selectionEnd);var h=" "==c.value.charAt(e)?!0:!1;a=(0==d||" "==c.value.charAt(d-1)?"":" ")+a;a+=h?"":" ";c.value=c.value.substring(0,d)+a+c.value.substring(e);a=d+a.length+(h?1:0);b.selection?
(g.moveEnd("character",-c.value.length),g.moveEnd("character",a),g.moveStart("character",a),g.select()):"null"!=c.selectionStart&&(c.selectionStart=a,c.selectionEnd=a);c.focus()};cbx.msgModeStr="";
cbx.setInputMode=function(a){var b=cbx.$frm;b.pst.value==b.pst.x_placeholder&&(b.pst.value="");"undefined"===typeof a&&(a="",b.pst.value.substring(0,cbx.msgModeStr.length)==cbx.msgModeStr&&(a=cbx.msgModeStr),b.pst.value="");if(b.pst.value.substring(0,a.length)!==a){var c=b.pst.value.substring(cbx.msgModeStr.length+(cbx.msgModeStr?1:0));b.pst.value=(a?a+" ":"")+c;cbx.msgModeStr=a}b.pst.focus();a=b.pst;"number"==typeof a.selectionStart?a.selectionStart=a.selectionEnd=a.value.length:"undefined"!=typeof a.createTextRange&&
(a.focus(),a=a.createTextRange(),a.collapse(!1),a.select())};
var makeButton=function(){return function(a,b,c,d,e,g){var h=null,k="",l="",m={disable:function(){k="disabled";h.className=l+" Disabled";return m},enable:function(){k="interactive";h.className=l+" Interactive";h.style.display="";return m},hide:function(){k="hidden";h.style.display="none";return m},text:function(a){p.textContent=a;return m},onclick:function(a){h.onclick=function(b){if("interactive"!=k)return!1;a(m);b.stopPropagation();b.preventDefault=!0;return!1};return m},icon:function(a){n.className=
"ico "+a;return m},tip:function(a){h.title=a||"";return m},element:function(){return h},addClass:function(a){l+=" "+a;h.className=l;return m},id:g};e&&(h=document.getElementById(e));h||(e&&cbx.debug.log("Elem "+e+" not found; creating.","BTN"),h=document.createElement("button"),h.type="button",e&&(h.id=e));h.innerHTML="";var l=h.className,k="disabled",n=document.createElement("i");m.icon(a);var p=document.createElement("span");m.text(b);h.appendChild(n);h.appendChild(p);m.tip(c);m.onclick(d);return m}}(),
msgTools=function(){var a=null,b=null;return{create:function(c){var d=document.createElement("div");d.className="msgtools";var e=document.createElement("div");e.className="btntray";for(var g=c.length-1;0<=g;g--)e.appendChild(makeButton(c[g].cN,"",c[g].text,c[g].call).enable().element());d.appendChild(e);d.appendChild(makeButton("EllipsisV","","",function(c){scrollFollow=!1;b=null;null!==a&&(a.className="msgtools",b=a,a=null);d!==b&&(d.className="msgtools Open",a=d)}).enable().element());return d}}}(),
imgOverlay=overlay.create("Image","Image"),showFullImage=function(a){a&&(a=a.replace(/cbox.im\/i\/([a-z0-9]+?)\.(.+?)\.([a-z0-9]{1,5})/i,"cbox.im/i/$1.$3"),overlay.switchTo(imgOverlay),imgOverlay.body.innerHTML='<img src="'+a+'">')},lnkd=[],msgToolsUpdate=function(){var a=!1;cbx.debug.log("msgToolsUpdate called");var b=cbx.gsUser.get("lvl"),c=cbx.gsUser.get("lpid"),d=cbx.gsUser.get("uid");2<b&&(a=!0);a&&s_mc&&s_tid!=s_mc?cbx.modBtn.enable():cbx.modBtn.hide();for(var e=messages.getAll(),g=0;g<e.length;g++){var h=
e[g],k=[];(function(e){var g=e.id;Emotes.enqueueAll(h);var n=h.querySelector("img.pic");n&&!n.onclick&&(n.onclick=function(){showFullImage(n.src)});(a||s_ld&&g==c&&g==cbx.lp&&1<b)&&0<g&&k.push({cN:"Trash",text:t17,call:function(){cbx.del(g);return!1}});a&&0<g&&e.uid!=d&&b>e.lvl&&4>e.lvl&&k.push({cN:"Ban",text:t18,call:function(){cbx.ban(g);return!1}});s_pm&&0<e.uid&&d&&e.uid!==d&&(a||2<e.lvl)&&k.push({cN:"Envelope",text:t15,call:function(){cbx.setInputMode("//pm "+e.uid);return!1}});s_mc&&a&&e.lvl<
b&&1<e.lvl&&k.push({cN:"VoiceOn",text:"Toggle voice",call:function(){var a=cbx.$frm;cbx.xhr("delban",{n:a.nme.value,k:a.key.value,voicetoggle:g},null,function(a,b){setStatus(b);if(!a)return!1;setStatus(a,"Okay")});return!1}});s_mc&&a&&e.isRedirected&&k.push({cN:"Accept",text:"Accept and publish",call:function(){var a=cbx.$frm;cbx.xhr("delban",{n:a.nme.value,k:a.key.value,repost:g},null,function(a,b){setStatus(b);if(!a)return!1;cbx.del_proc(g)});return!1}});lnkd[g]&&lnkd[g].parentElement&&(lnkd[g].parentElement.removeChild(lnkd[g]),
delete lnkd[g]);if(k.length){var p=msgTools.create(k);h.parentNode.insertBefore(p,h.nextSibling);lnkd[g]=p}})(messages.getData(h))}Emotes.load();if(s_nq&&document.getElementsByClassName)for(g in e=document.getElementsByClassName("nme"),e)e[g].parentElement&&"A"!==e[g].parentElement.tagName&&e[g].textContent&&(e[g].onclick=function(a){return function(b){a&&(b=String.fromCharCode(27),insertAtCaret(b+"@"+a+b))}}(e[g].textContent))};
cbx.ban=function(a){var b=cbx.$frm;cbx.xhr("delban",{n:b.nme.value,k:b.key.value,ban:a,dur:"24 hours"},null,function(a,b){setStatus(b);if(!a)return!1;a=a.split("\t");alert(a[1])})};cbx.del=function(a){var b=cbx.$frm;cbx.xhr("delban",{n:b.nme.value,k:b.key.value,del:a},null,function(a,b){setStatus(b);if(!a)return!1;cbx.del_proc(a)})};
cbx.del_proc=function(a,b){isNaN(b)&&(b=a);if(isNaN(a))return!1;for(var c=Math.min(a,b),d=Math.max(b,a),e=messages.getAll(),g=0,h=0;h<e.length;h++){var k=e[h],l=messages.getData(k);!l.isDeleted&&l.id>=1*c&&l.id<=1*d&&(k.className+=" Deleted",k.setAttribute("data-deleted",!0),g++)}c=document.querySelectorAll('#messages > .msg[data-deleted="true"] + .msgtools');for(h=0;h<c.length;h++)c[h].parentNode.removeChild(c[h]);window.setTimeout(function(){for(var a=document.querySelectorAll('#messages > .msg[data-deleted="true"]'),
b=0;b<a.length;b++)a[b].parentNode.removeChild(a[b])},500);return g};cbx.proc_rpc_del=function(a){a=a.split(",");for(var b,c,d=0;d<a.length;d++)0>a[d].indexOf("_")?(b=parseInt(a[d]),isNaN(b)||cbx.del_proc(b)):(c=a[d].split("_"),b=parseInt(c[0]),c=parseInt(c[1]),isNaN(b)||isNaN(c)||cbx.del_proc(b,c))};var gips=[];cbx.getip=function(a,b){var c=cbx.$frm;gips[a]||(gips[a]=!0,cbx.xhr("getip",{n:c.nme.value,k:c.key.value,i:a},null,function(c,e){if(!c||e)return gips[a]=!1;b&&(b.title=t18+" (IP: "+c+")")}))};
var updateFavicon=function(){var a=document.createElement("canvas"),b=document.createElement("link");if(!a.getContext)return function(){};var c=a.getContext("2d");a.height=a.width=16;for(var d=document.getElementsByTagName("link"),e=0;e<d.length;e++){var g=d[e].getAttribute("rel");g&&g.match(/icon/)&&d[e].parentElement.removeChild(d[e])}return function(d){c.font='bold 11px "Helvetica", "Tahoma", sans-serif';c.clearRect(0,0,a.width,a.height);var e="";!isNaN(d)&&0<d&&(e=50>1*d?1*d:"99",d=c.measureText(e),
c.fillStyle="rgba(255, 255, 255, 0.9)",c.fillRect(a.width-d.width,a.height-11,d.width,11),c.fillStyle="#dd2211",c.textBaseline="top",c.fillText(e,a.width-d.width,a.height-11));b.rel="icon";b.type="image/png";b.href=a.toDataURL("image/png");b.parentNode!==document.head&&document.head.appendChild(b)}}(),titleT=null;
function titleflash(){if(parent===window&&!windowIsFocused&&(updateFavicon(unreadMessages.length),!scrollFollow)){var a=!1;document.title="New message! - Cbox";titleT=window.setTimeout(function(){document.title=a?"New message! - Cbox":"Cbox";a=!a},2E3)}}
var loadSWF=function(a,b){function c(a,b){return'<param name="'+a+'" value="'+b+'">'}window.document.getElementsByTagName("html");var d,e;d={name:a,id:a,src:b,quality:"high",allowScriptAccess:"always",bgcolor:"#ffffff",pluginspage:"http://www.macromedia.com/go/getflashplayer",title:"FL",type:"application/x-shockwave-flash",hasPriority:"true",width:1,height:1};e={position:"absolute",width:"8px",height:"8px",bottom:"0px",left:"-10px",overflow:"hidden","z-index":"10000"};var g="",h;for(h in d)g+=h+'="'+
d[h]+'" ';var k="";for(h in e)k+=h+": "+e[h]+"; ";d=['<object style="'+k+'" id="'+a+'" data="'+b+'" type="'+d.type+'" title="'+d.title+'" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0">',c("movie",b),c("AllowScriptAccess",d.allowScriptAccess),c("quality",d.quality),c("bgcolor",d.bgcolor),c("hasPriority",d.hasPriority),"<embed "+g+">","</object>"].join("");e=document.getElementById("flash_"+a)||document.createElement("div");
e.id="flash_"+a;document.body.appendChild(e);e.innerHTML=d;return document[a]},audioPlay=function(a){},initAudio=function(a){if(s_sn){var b={volAll:20,volTag:100},c={0:"Mute",20:"Low",100:"High"},d=cbx.gsUser.get("audiovols");if(d)for(var e in b)"undefined"===typeof d[e]||0!=d[e]&&20!=d[e]&&100!=d[e]||(b[e]=1*d[e]);var g=function(){var a=0,c;for(c in b)a=Math.max(a,b[c]);return a},h=overlay.create("Notification options","Audio"),d=function(a){var d;d=a.id;d=100==b[d]?b[d]=20:20==b[d]?b[d]=0:b[d]=
100;a.icon("Volume"+c[d]);cbx.audio.play(d);k.icon("Volume"+c[g()]);cbx.gsUser.set("audiovols",b)};e=document.createElement("fieldset");e.appendChild(makeButton("Volume"+c[b.volAll],"On new messages","",d,"","volAll").addClass("Full").enable().element());e.appendChild(makeButton("Volume"+c[b.volTag],"On @tagged messages","",d,"","volTag").addClass("Full").enable().element());h.body.appendChild(e);var k=makeButton("VolumeMute","","Notification options",function(){overlay.switchTo(h)},"btnVolume");
k.icon("Volume"+c[g()]);k.enable();cbx.audio.setup(a);audioPlay=function(a){cbx.audio.play(b[a]||0)}}};
cbx.audio=function(){var a=function(a){cbx.debug.log(a,"AUDIO")};return{play:function(){a("Play called but not configured.")},setup:function(b){a("Setup called with "+b);var c=null,d=function(){window.soundManager={_externalInterfaceOK:function(d){a("SWF: ExternalInterface online! Version: "+d);window.setTimeout(function(){c._createSound("cbxsnd",1,!1)},100);window.setTimeout(function(){a("Flash: loading "+b+".mp3");c._load("cbxsnd",b+".mp3",!0,!1,!1)},500)},sounds:{cbxsnd:{_onload:function(b){b?
(a("SWF: Loaded - configuring for play."),cbx.audio.play=function(b){a("Flash play called at volume "+b);c._setVolume("cbxsnd",b);c._start("cbxsnd",1,0,!1)}):a("SWF: Load failed - not switching play")},_onfinish:function(){a("SWF: Got onfinish")}}}};cbx.audio.play=function(b){a("Play waiting on flash")};a("Attempting to load Flash object...");var c=loadSWF("SMswf",window.smuri)};if(!("Audio"in window))return a("No Audio object found - fast fallback."),d(),!1;var e=null,c=new Audio,g=function(){window.clearTimeout(k);
c?(a("Ready: Canplaythrough duration "+c.duration+". Setting play() handler"),cbx.audio.play=function(b){c?e?a("Play ongoing."):0!=b&&(e=window.setTimeout(function(){a("Play timeout. Falling back.");d()},5E3),cbx.audio.playStart=(new Date).getTime(),c.volume=b/100,c.play()):a("Play fired by object destroyed")},c.removeEventListener("canplaythrough",g,!1)):a("Ready fired but object destroyed.")},h=".ogg";c.canPlayType&&c.canPlayType('audio/ogg; codecs="vorbis"').replace(/no/,"")||(h=".mp3");a("Audio object created; chose "+
h);var k=window.setTimeout(function(){a("Load timeout. Falling back.");c=null;d()},5E3);c.addEventListener("canplaythrough",g,!1);c.addEventListener("error",function(b){a("Got error. Falling back");window.clearTimeout(k);e&&(window.clearTimeout(e),e=null);c=null;d()},!1);c.addEventListener("timeupdate",function(a){c&&c.currentTime&&null!==e&&(window.clearTimeout(e),e=null)},!1);a("Setting source: "+b+h);c.setAttribute("src",b+h)}}}();
cbx.repl=function(){var a="repl:",b=0,c="xxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0;return("x"==a?b:b&3|8).toString(16)}),d=function(a){if(a!==b&&(b=a,n.state=b,n.onstatechange))n.onstatechange()},e=0,g=function(){var b=(new Date).getTime(),g=null,h=null;try{g=localStorage.getItem(a+":master"),h=JSON.parse(g)}catch(k){}g=function(){try{localStorage.setItem(a+":master",JSON.stringify({id:c,tme:b}))}catch(d){}};n.masterID=null;h&&h.id?h.tme<b-2*(b-e)?(g(),d(3)):h.id!==c?(n.masterID=
h.id,m(),d(4)):(g(),d(2)):(d(1),g());e=b},h=0,k=null,l=!0,m=function(c){if(4===b){var d=null,e={};if(c&&c.key){if(c.key!==a+":buffer")return;d=c.newValue;e=JSON.parse(d)||{}}else try{d=localStorage.getItem(a+":buffer"),e=JSON.parse(d)||{}}catch(g){return}if(e&&e.pos!==k)if(k=e.pos,l)l=!1;else if("undefined"!==typeof e.msg&&n.onmessage)n.onmessage(e.msg)}},n={start:function(d){0<b||"string"!==typeof d||1>d.length||(a+=d,n.clientID=c,window.setTimeout(g,0),window.setInterval(g,2E3),window.addEventListener?
(window.addEventListener("storage",m),window.addEventListener("unload",n.stop)):(window.document.attachEvent("onstorage",m),window.attachEvent("onunload",n.stop)))},stop:function(){if(4!==b){try{localStorage.removeItem(a+":master"),localStorage.removeItem(a+":buffer")}catch(c){}d(0)}},onmessage:function(){},sendmessage:function(d){if(4!==b){h++;try{localStorage.setItem(a+":buffer",JSON.stringify({msg:d,pos:c+h}))}catch(e){}}},pump:m,state:null,onstatechange:function(){},clientID:null,masterID:null};
return n}();
cbx.FP=function(){var a=2,b=2;try{a=1*!!window.indexedDB}catch(c){}try{b=1*!!window.openDatabase}catch(d){}var e=function(){var c=navigator;return[c.userAgent,c.language||c.userLanguage||c.browserLanguage||c.systemLanguage,c.languages&&c.languages.join(","),screen.colorDepth,screen.width,screen.height,screen.availHeight,screen.availWidth,(new Date).getTimezoneOffset(),a,b,c.cpuClass,c.platform,c.doNotTrack,c.maxTouchPoints||c.msMaxTouchPoints,g()].join("|")},g=function(){try{var a=document.createElement("canvas");a.width=
400;a.height=200;a.style.display="inline";var b=a.getContext("2d");b.textBaseline="alphabetic";b.fillStyle="#f60";b.fillRect(125,1,62,20);b.fillStyle="#069";b.font="23pt Arial";b.fillText("DWM fjordbank vext zz4, \ud83d\ude03",2,15);b.fillStyle="rgba(102, 204, 0, 0.7)";b.font="23pt Arial";b.fillText("DWM fjordbank vext zz4, \ud83d\ude03",4,45);b.globalCompositeOperation="multiply";b.fillStyle="rgb(255,0,255)";b.beginPath();b.arc(50,50,50,0,2*Math.PI,!0);b.closePath();b.fill();b.fillStyle="rgb(0,255,255)";
b.beginPath();b.arc(100,50,50,0,2*Math.PI,!0);b.closePath();b.fill();b.fillStyle="rgb(255,255,0)";b.beginPath();b.arc(75,100,50,0,2*Math.PI,!0);b.closePath();b.fill();b.fillStyle="rgb(255,0,255)";b.arc(75,75,75,0,2*Math.PI,!0);b.arc(75,75,25,0,2*Math.PI,!0);b.fill("evenodd");return a.toDataURL()}catch(c){return""}};return{string:function(a){window.setTimeout(function(){a(e())},0)},hash:function(a){window.setTimeout(function(){var b=e(),c=0,d,g,p,b=b+"";d=0;for(p=b.length;d<p;d++)g=b.charCodeAt(d),
c=(c<<5)-c+g,c|=0;a(c)},0)}}}();
cbx.addTypingHandler=function(){return function(a,b){var c="IDLE",d=null,e=null,g=0,h=null,k=function(a){c!==a&&(c=a,null!==e&&(window.clearTimeout(e),e=null),a=(new Date).getTime()-g,e=window.setTimeout(function(){d!==c&&(b("TYPING"==c?!0:!1),d=c);g=(new Date).getTime()},"TYPING"==c?2500:1E3>a?1E3-a:0))},l=function(){null!==h&&(window.clearTimeout(h),h=null);2>a.value.length?k("IDLE"):(k("TYPING"),h=window.setTimeout(function(){k("IDLE")},1500))};a.addEventListener?a.addEventListener("keyup",l,!1):
el.attachEvent&&a.attachEvent("onkeyup",l)}}();
var profileBtn=null,profileBtnSetup=function(){var a=overlay.create("Your profile","Profile");a.body=document.getElementById("pgProfile");var b=makeButton("SignOut","Log out","",function(a){cbx.getUserStatus(!0);overlay.switchTo()},"btnLogout").hide(),c=function(){var a=document.getElementById("imgContainer");a.innerHTML="";if(a&&cbx.$frm.pic&&cbx.$frm.pic.value){var b=document.createElement("img");b.src=cbx.$frm.pic.value;a.appendChild(b)}else a.innerHTML='<i class="ico Camera" style="font-size: 8em;">'},
d=function(){overlay.switchTo(a);b.hide();1<cbx.gsUser.get("lvl")&&b.enable();var d=document.getElementById("inpProfileURL");d&&cbx.$frm.eml&&(d.value=cbx.$frm.eml.value,d.onchange=function(){cbx.$frm.eml.value=d.value;cbx.gsUser.set("eml",d.value)});s_av&&(c(),window.UploaderReady=function(a){a=a({authKey:window.img_key,authUser:window.img_usr,authApp:"cbox",maxFileSize:1E6,onevent:function(a,b){cbx.debug.log("Event "+a+": "+b,"UPLOAD");"done"==a&&(cbx.$frm.pic.value="https://"+b,cbx.gsUser.set("pic",
"https://"+b),c());"error"==a&&setStatus(b,"Warn")}});var b=document.getElementById("btnAvatar");b.className+=" Interactive";b.appendChild(a)},function(a,b,c){var d=a.getElementsByTagName(b)[0];a.getElementById(c)||(a=a.createElement(b),a.id=c,a.src="https://cbox.im/imgs/uploader2.js?115",d.parentNode.insertBefore(a,d))}(document,"script","cbox-uploader"))};profileBtn=makeButton("User","","Your Profile",function(){d()},"btnUser");profileBtn.enable()},authBtnSetup=function(){var a,b,c=overlay.create("Register / login",
"Auth"),d=function(a,b,d){overlay.switchTo(c);var g=c.body,h=document.getElementById("authForm");g.innerHTML="";g.appendChild(h);g=["Show"];g.push("login"==a?"Login":"Reg");makeButton("SignIn","login"==a?t27:t28,"",function(a){h.onsubmit()},"authSubmit").enable();-1<b.indexOf("pw")&&g.push("WithPW");-1<b.indexOf("fb")&&g.push("WithFB");h.className=g.join(" ");var q="",r="";-1<b.indexOf("fb")&&fbLoginSetup("btnLoginFB",function(a){q="fb";r=a;h.onsubmit()});var s=cbx.$frm.nme.value,t=cbx.$frm.key.value;
document.getElementById("authMsg").textContent=d||"";h.onsubmit=function(){for(var b={n:s,k:t,pword:h.pword.value,pword2:h.pword2.value,auth_prov:q,auth_id:r,"do":a},c=0;c<h.elements.length;c++)h.elements[c].value="";cbx.xhr("profile",{json:1},b,function(a,b){if(b)setStatus(b);else{var c=JSON.parse(a);c.error?setStatus(c.error):"LOGGED_IN"!=c.state?setStatus(c.state):(c.udata&&cbx.updateUser(c.udata),overlay.switchTo(),e())}});return!1}},e=function(){profileBtn.text(b.value);b.style.display="none";
a.hide();cbx.autoScroll()},g=cbx.getUserStatus=function(c,h){if(b&&b.value.length){var m=b.value,n={LOGGED_IN:function(){e()},LOGGED_OUT:function(){profileBtn.text("");b.style.display="";a.enable();cbx.autoScroll();cbx.updateUser({key:"",lvl:1})},NAME_COLLISION:function(c,e){h?d("login",c,e):a.onclick(function(){m!==b.value?g(!1,!0):d("login",c,e)}).enable()},CAN_REGISTER:function(c,e){h?d("register",c,e):a.onclick(function(){m!==b.value?g(!1,!0):d("register",c,e)}).enable()},CANNOT_REGISTER:function(b){a.onclick(function(){}).disable()}},
p={n:f.nme.value,k:f.key.value,"do":"query"};c&&(p["do"]="logout");a.disable();cbx.xhr("profile",{json:1},p,function(a,b){if(b)cbx.debug.log(b,"AUTH");else{var c=JSON.parse(a);cbx.debug.log(c.state,"AUTH");if(n[c.state])n[c.state](c.auth_methods,c.message.replace(/\%s/,cbx.$frm.nme.value))}})}},h=null;return function(c,d){c&&d&&(a=makeButton("SignIn","","Login / register",function(){g()},c),b=d,window.setTimeout(function(){g()},800),b.onchange=function(){null!==h&&(window.clearTimeout(h),h=null);
""==b.value?a.disable():g()},a.onclick(function(){g(!1,!0)}),b.onkeyup=function(){null!==h&&(window.clearTimeout(h),h=null);""==b.value?a.disable():h=window.setTimeout(function(){g()},500)})}}(),fbLoginSetup=function(){var a=function(a){cbx.debug.log(a,"FBBTN")},b=null,c=null,d=!1,e=!1,g=function(e){a("Got login status: "+e.status);document.getElementById(b).className="btnAuthFB Interactive";if("connected"!==e.status)document.getElementById(b).onclick=function(){d=!0;a("Doing login...");FB.login(g,
{scope:"public_profile,email",return_scopes:!0})};else{var k=function(){document.getElementById(b).className="btnAuthFB Loading";document.getElementById(b).onclick=function(){};a("Got access token");c(e.authResponse.accessToken)};document.getElementById(b).onclick=function(){d=!0;k()};d&&k()}};return function(h,k){b=h;c=k;e?(d=!1,document.getElementById(b).onclick=null,document.getElementById(b).className="btnAuthFB Loading",FB.getLoginStatus(g)):(a("Loading FB lib..."),document.getElementById(b).className=
"btnAuthFB Loading",function(a,b,c){var d=a.getElementsByTagName(b)[0];a.getElementById(c)||(a=a.createElement(b),a.id=c,a.src="//connect.facebook.net/en_US/sdk.js",d.parentNode.insertBefore(a,d))}(document,"script","facebook-jssdk"),window.fbAsyncInit=function(){a("Got FB init; awaiting login status");e=!0;FB.init({appId:"701215030022299",cookie:!1,xfbml:!1,version:"v2.2"});FB.getLoginStatus(g)})}}();window.CBXREADY?window.CBXREADY():window.CBXREADY=!0;
